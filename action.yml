name: 'Knock knock, its Leviathan Time'
description: 'Test your software directly on hardware using the Levaithan Testing framework'
runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Test
      working-directory: ${{ env.LEVIATHAN_ROOT }} 
      shell: bash
      run: |
        make config
        make build
        make local-test QEMU_SECUREBOOT=${QEMU_SECUREBOOT} FLASHER_SECUREBOOT=${FLASHER_SECUREBOOT} || exit 1

    - uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4
      env:
        WORKER_TYPE: ${{ env.WORKER_TYPE }}
        DEVICE_TYPE: ${{ env.DEVICE_TYPE }}
      with:
        name: reports-${{ env.WORKER_TYPE }}-${{ env.DEVICE_TYPE }}
        path: ${{ env.REPORTS }}

    - name: Teardown
      shell: bash
      working-directory: ${{ env.LEVIATHAN_ROOT }} 
      run: |
        make down


# Stick leviathan action into the yocto-build.yml
# See if you can use whoami for BALENACLOUD_ORG value in config,js

## SPACE FOR THOUGHTS

# AFTER MVP Add a way to swap leviathan debug for one of runs

# if [ ! -z "$LEVIATHAN_DEBUG" ]
# then
#   perl -i~ -0777 -pe "s/debug: ({|\[)[^}\]]+(}|\])/debug: {$LEVIATHAN_DEBUG/g" .leviathan-inputs/config.js
# fi

#  Why even this exists? Find out

# if [ ! -z "$LEVIATHAN_NETWORK_WIRED" = true ]
# then
#   perl -i~ -0777 -pe "s/networkWired: [^,]+,/networkWired: true,/g" .leviathan-inputs/config.js
#   perl -i~ -0777 -pe "s/networkWireless: [^,]+,/networkWireless: false,/g" .leviathan-inputs/config.js
# fi

## Test for multiple fleets, envs, and devices
